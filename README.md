# Распределённое key-value хранилище

Программа представляет собой узел распределённого key-value хранилища, использующего RAFT. Узлы общаются между собой через gRPC, описание протокола лежит [тут](proto/raft.proto).

## Запуск

### Генерация protobuf

Для начала нужно сгенерировать код для protobuf, который используется в gRPC:

```bash
mkdir generated
```

```bash
protoc --go_out=generated --go_opt=paths=source_relative --go-grpc_out=generated --go-grpc_opt=paths=source_relative proto/raft.proto
```

### Конфигурация

Каждый узел конфигурируется в своём .env-файле (**1.env**, **2.env**, **3.env** и т.д. — файлы для конфигурации первого, второго, третьего и других узлов). Конфигурационный файл должен содержать следующие переменные окружения:

| Название                | Описание                                                                                               |
|-------------------------|--------------------------------------------------------------------------------------------------------|
| EXECUTED_COMMANDS_KEY   | Ключ в key-value хранилище, по которому лежит информация про все выполненные команды журнала хранилища |
| SELF_ADDRESS            | Адрес текущего узла, к которому должны обращаться другие узлы                                          |
| SELF_ID                 | Идентификатор текущего узла                                                                            |
| OTHER_NODES             | Список адресов других узлов                                                                            |
| BROADCAST_TIME_MS       | Таймаут для отправки *AppendEntries*                                                                   |
| MIN_ELECTION_TIMEOUT_MS | Минимальный таймаут для становления кандидатом и начала нового терма                                   |
| MAX_ELECTION_TIMEOUT_MS | Максимальный таймаут для становления кандидатом и начала нового терма                                  |
| REST_ADDRESS            | Адрес, по которому клиенты (не узлы!) могут обращаться по REST API к узлу для выполнения запросов      |

> Идентификаторы узлов должны быть уникальны!

## Запуск узла

Для запуска узлов можно использовать bash-скрипты **run1.sh**, **run2.sh**, **run3.sh** и т.д. 

> Конфигурация кластера такова, что он состоит из 5 узлов, поэтому для выбора лидера (а значит и принятия решений) нужно запустить как минимум 3 узла. Если узлов будет меньше, то лидера выбран и key-value хранилище не сможет полноценно работать

## Взаимодействие с клиентом

Каждый запущенный узел реализует REST API (OpenAPI-схема лежит в [тут](api/swagger.json) и [тут](api/swagger.yaml)). Также у каждого запущенного узла доступен swagger по пути `/swagger/index.html`.
